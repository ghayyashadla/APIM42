<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ITSM Form</title>
</head>
<body>

    <h1>ITSM Form</h1>

    <form id="itsmForm">
        <label for="summary">Summary:</label>
        <input type="text" id="summary" name="summary" required><br>

        <label for="description">Description:</label>
        <textarea id="description" name="description" required></textarea><br>

        <button type="button" onclick="authenticateAndSubmit()">Submit</button>
    </form>

    <script>
        async function authenticateAndSubmit() {
            // Replace with your actual authentication endpoint
            var authUrl = 'https://twe044srv.imagoverum.com/M42Services/api/ApiToken/GenerateAccessTokenFromApiToken/';

            // Replace 'YOUR_API_TOKEN' with the actual API token
            var apiToken = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1bmlxdWVfbmFtZSI6ImltYWdvdmVydW0uY29tXFxBZG1pbmlzdHJhdG9yIiwibmFtZWlkIjoiaW1hZ292ZXJ1bS5jb21cXEFkbWluaXN0cmF0b3IiLCJVc2VyRnJhZ21lbnRJZCI6ImRiZWU5NzYyLTk4MGEtZTUxMS04MGQ4LTAwNTA1NjJmOTUxNiIsImlzcyI6Imh0dHBzOi8vc3RzLm1hdHJpeDQyLmNvbSIsImF1ZCI6InVybjptYXRyaXg0MkFwaSIsImV4cCI6MjE0NzQ4MzY0NiwibmJmIjoxNzA3MTI2ODQ2fQ.wSbTYD3KBjk9DIlWaqT_VIiC1zvNhtx36NoRJExmDRY';

            var authData = {
                apiToken: apiToken
            };

            try {
                // Step 1: Authenticate and obtain access token
                const authResponse = await fetch(authUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(authData),
                });

                if (!authResponse.ok) {
                    throw new Error('Authentication failed');
                }

                const { RawToken } = await authResponse.json();

                // Step 2: Get form data
                var summary = document.getElementById("summary").value;
                var description = document.getElementById("description").value;

                // Step 3: Make REST API call with access token
                await sendToITSM(summary, description, RawToken);
            } catch (error) {
                console.error('Error during authentication:', error);
                alert('Error submitting form. Please try again.');
            }
        }

        async function sendToITSM(summary, description, accessToken) {
            // Replace the following URL with your actual ITSM API endpoint
            var apiUrl = 'https://twe044srv.imagoverum.com/m42Services/api/ticket/Create?activityType=0';

            // Create data object
            var data = {
                Subject: summary,
                Description: description,
                // Add other properties as needed based on your ITSM API requirements
            };

            try {
                // Make REST API call with access token
                const apiResponse = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + accessToken,
                    },
                    body: JSON.stringify(data),
                });

                if (!apiResponse.ok) {
                    throw new Error('API call failed');
                }

                // Handle successful API call
                alert('Form submitted successfully!');
            } catch (error) {
                // Handle API call errors
                console.error('Error during API call:', error);
                alert('Error submitting form. Please try again.');
            }
        }
    </script>

</body>
</html>
